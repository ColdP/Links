<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="appTitle">上或者不上 - 魅惑度评估器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        /* Material Design 3 Expressive - Color Variables */
        :root {
            /* Light Theme */
            --md-sys-color-primary: #6750A4; /* Indigo */
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #EADDFF;
            --md-sys-color-on-primary-container: #21005D;

            --md-sys-color-secondary: #625B71; /* Purple-Gray */
            --md-sys-color-on-secondary: #FFFFFF;
            --md-sys-color-secondary-container: #E8DEF8;
            --md-sys-color-on-secondary-container: #1D192B;

            --md-sys-color-tertiary: #7D5260; /* Deep Rose */
            --md-sys-color-on-tertiary: #FFFFFF;
            --md-sys-color-tertiary-container: #FFD8E4;
            --md-sys-color-on-tertiary-container: #31111D;

            --md-sys-color-error: #B3261E;
            --md-sys-color-on-error: #FFFFFF;
            --md-sys-color-error-container: #F9DEDC;
            --md-sys-color-on-error-container: #410E0B;

            --md-sys-color-background: #FFFBFE; /* Off-white */
            --md-sys-color-on-background: #1C1B1F; /* Dark gray */

            --md-sys-color-surface: #FFFBFE; /* Off-white */
            --md-sys-color-on-surface: #1C1B1F; /* Dark gray */
            --md-sys-color-surface-variant: #E7E0EC; /* Light gray-purple */
            --md-sys-color-on-surface-variant: #49454F; /* Medium gray-purple */
            --md-sys-color-outline: #79747E; /* Medium gray */
            --md-sys-color-shadow: #000000;
            --md-sys-color-inverse-surface: #313033;
            --md-sys-color-inverse-on-surface: #F4EFF4;
            --md-sys-color-inverse-primary: #D0BCFF;

            /* Custom Explicit Phrase Color - Light */
            --color-explicit-phrase: #DB2777; /* Tailwind pink-600 */
        }

        /* Dark Theme */
        html.dark {
            --md-sys-color-primary: #D0BCFF; /* Light Indigo */
            --md-sys-color-on-primary: #381E72;
            --md-sys-color-primary-container: #4F378B;
            --md-sys-color-on-primary-container: #EADDFF;

            --md-sys-color-secondary: #CCC2DC; /* Light Purple-Gray */
            --md-sys-color-on-secondary: #332D41;
            --md-sys-color-secondary-container: #4A4458;
            --md-sys-color-on-secondary-container: #E8DEF8;

            --md-sys-color-tertiary: #EFB8C8; /* Light Deep Rose */
            --md-sys-color-on-tertiary: #492532;
            --md-sys-color-tertiary-container: #633B48;
            --md-sys-color-on-tertiary-container: #FFD8E4;

            --md-sys-color-error: #F2B8B5;
            --md-sys-color-on-error: #601410;
            --md-sys-color-error-container: #8C1D18;
            --md-sys-color-on-error-container: #F9DEDC;

            --md-sys-color-background: #1C1B1F; /* Dark gray */
            --md-sys-color-on-background: #E6E1E5; /* Light gray */

            --md-sys-color-surface: #1C1B1F; /* Dark gray */
            --md-sys-color-on-surface: #E6E1E5; /* Light gray */
            --md-sys-color-surface-variant: #49454F; /* Medium dark gray-purple */
            --md-sys-color-on-surface-variant: #CCC2DC; /* Light purple-gray */
            --md-sys-color-outline: #938F99; /* Medium gray */
            --md-sys-color-shadow: #000000;
            --md-sys-color-inverse-surface: #E6E1E5;
            --md-sys-color-inverse-on-surface: #313033;
            --md-sys-color-inverse-primary: #6750A4;

            /* Custom Explicit Phrase Color - Dark */
            --color-explicit-phrase: #F472B6; /* Tailwind pink-400 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .main-container {
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            border: 1px solid var(--md-sys-color-outline);
            border-radius: 1.5rem; /* rounded-3xl */
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2); /* More prominent shadow for M3 elevation */
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        /* General element styling with M3 variables */
        h1, h2 { color: var(--md-sys-color-on-surface); }
        p, label, select, input[type="file"] { color: var(--md-sys-color-on-surface-variant); }
        .text-indigo-600 { color: var(--md-sys-color-primary); } /* Header accent color */
        .text-pink-600 { color: var(--md-sys-color-tertiary); } /* Header accent color */
        .explicit-phrase {
            color: var(--color-explicit-phrase);
            text-shadow: 1px 1px 3px rgba(0,0,0,0.15); /* Subtle shadow for text */
        }
        #scoreDisplay { color: var(--md-sys-color-primary); } /* Score uses primary color */


        /* Input/Select/File Button common styles */
        .form-element-base {
            border: 1px solid var(--md-sys-color-outline);
            background-color: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface-variant);
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            transition: all 0.2s ease;
        }
        .form-element-base:focus {
            outline: none;
            border-color: var(--md-sys-color-primary);
            box-shadow: 0 0 0 2px var(--md-sys-color-primary-container);
        }

        select.form-element-base {
            appearance: none; /* Remove default arrow */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%2349454F'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.25em 1.25em;
            padding-right: 2.5rem; /* Make space for the custom arrow */
        }

        input[type="file"].form-element-base {
            padding: 0; /* Override default input padding */
        }
        input[type="file"].form-element-base::file-selector-button {
            margin-right: 1rem; /* mr-4 */
            padding: 0.5rem 1rem; /* py-2 px-4 */
            border-radius: 9999px; /* rounded-full */
            border: 0;
            font-size: 0.875rem; /* text-sm */
            font-weight: 600; /* font-semibold */
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        input[type="file"].form-element-base::file-selector-button:hover {
            background-color: var(--md-sys-color-primary-container);
            opacity: 0.9;
        }


        /* Image preview container */
        #imagePreviewContainer {
            background-color: var(--md-sys-color-surface-variant);
            border-color: var(--md-sys-color-outline);
        }

        /* Custom toggle switch styles (M3 compliant) */
        .toggle-switch .slider {
            background-color: var(--md-sys-color-outline);
        }
        input:checked + .slider {
            background-color: var(--md-sys-color-primary);
        }
        input:focus + .slider {
            box-shadow: 0 0 1px var(--md-sys-color-primary);
        }

        /* Language Switch Button Styles (M3 Expressive) */
        .language-button-container {
            display: flex;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: 9999px; /* rounded-full */
            overflow: hidden;
            background-color: var(--md-sys-color-surface-variant); /* Background for the whole segment control */
            width: 100%;
            max-width: 240px; /* Adjusted max-width */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); /* Subtle inset shadow */
        }

        .language-button-half {
            padding: 0.625rem 1.25rem; /* py-2.5 px-5 (more generous padding) */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* Medium weight */
            color: var(--md-sys-color-on-surface-variant);
            cursor: pointer;
            transition: all 0.2s ease;
            flex-grow: 1;
            text-align: center;
            user-select: none;
            position: relative; /* For the active state overlay */
            isolation: isolate; /* Create new stacking context */
        }

        .language-button-half.active {
            font-weight: 600; /* Bolder text for active */
            color: var(--md-sys-color-on-primary); /* White text on primary background */
            z-index: 1; /* Bring active segment to front */
        }

        .language-button-half.active::before {
            content: '';
            position: absolute;
            inset: 0;
            background-color: var(--md-sys-color-primary);
            border-radius: 9999px; /* rounded-full for the active background */
            z-index: -1; /* Place behind text */
            box-shadow: 0 2px 4px rgba(0,0,0,0.15); /* Subtle shadow for active segment */
            transition: all 0.2s ease;
        }

        /* Dark Mode Toggle Button */
        #darkModeToggle {
            background-color: var(--md-sys-color-surface-variant);
            border: 1px solid var(--md-sys-color-outline);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* Slight shadow */
            transition: all 0.2s ease;
            width: 48px; /* Fixed width */
            height: 48px; /* Fixed height for 1:1 aspect ratio */
            display: flex; /* Use flexbox to center content */
            align-items: center; /* Center vertically */
            justify-content: center; /* Center horizontally */
            padding: 0; /* Remove default padding as size is fixed */
        }
        #darkModeToggle:hover {
            background-color: color-mix(in srgb, var(--md-sys-color-surface-variant) 90%, var(--md-sys-color-primary)); /* Slight primary tint on hover */
            border-color: var(--md-sys-color-primary); /* Border changes to primary on hover */
            box-shadow: 0 4px 8px rgba(0,0,0,0.15); /* Stronger shadow on hover */
        }
        #darkModeToggle .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; /* Ensure icon is 24px default size */
            color: var(--md-sys-color-on-surface-variant); /* Icon color based on text color */
            transition: color 0.2s ease; /* Smooth icon color transition */
        }
        #darkModeToggle:hover .material-symbols-outlined {
            color: var(--md-sys-color-primary); /* Icon becomes primary color on hover */
        }


        /* Action Button (Analyze Button) */
        #analyzeButton {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border: 2px solid var(--md-sys-color-outline); /* Border with outline color for distinction */
            transition: all 0.3s ease; /* Ensure all transitions are smooth */
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); /* Initial shadow */
        }

        #analyzeButton:hover {
            background-color: var(--md-sys-color-primary-container); /* Lighter primary tint on hover */
            color: var(--md-sys-color-on-primary-container); /* Darker text on lighter background */
            border-color: var(--md-sys-color-primary); /* Border changes to primary on hover for a "pop" */
            transform: translateY(-2px); /* Lift effect */
            box-shadow: 0 8px 16px rgba(0,0,0,0.3); /* Stronger shadow */
        }

        #analyzeButton:disabled {
            background-color: var(--md-sys-color-surface-variant); /* Muted background */
            color: var(--md-sys-color-on-surface-variant); /* Muted text */
            border-color: var(--md-sys-color-outline); /* Muted border */
            opacity: 0.6; /* Slight opacity for disabled state */
            cursor: not-allowed;
            transform: none; /* No lift effect when disabled */
            box-shadow: none; /* No shadow when disabled */
        }


        /* Result Container Styling */
        #resultContainer {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
            border: 1px solid var(--md-sys-color-outline); /* Use outline for border */
        }
        #resultHeaderText {
            color: var(--md-sys-color-on-secondary-container);
        }
        #descriptionDisplay, #reasonDisplay {
            color: var(--md-sys-color-on-secondary-container);
        }

        /* Error Message Styling */
        #errorMessage {
            background-color: var(--md-sys-color-error-container);
            color: var(--md-sys-color-on-error-container);
            border-color: var(--md-sys-color-error); /* Use error color for border */
        }
        #errorPrefix {
            color: var(--md-sys-color-on-error-container);
        }

        /* Disclaimer Styling */
        #disclaimerText {
            color: var(--md-sys-color-on-surface-variant);
        }
        #disclaimerPrefix {
            color: var(--md-sys-color-on-surface-variant);
        }

        /* Spinners use on-primary for better visibility on primary button */
        .spinner {
            border-left-color: var(--md-sys-color-on-primary);
        }

        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Dark overlay */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000; /* High z-index to cover everything */
            transition: opacity 0.3s ease;
            opacity: 0;
            visibility: hidden;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            padding: 1.5rem;
            border-radius: 1.5rem; /* rounded-3xl */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            position: relative;
            transform: scale(0.95);
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
            opacity: 1;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--md-sys-color-outline);
            padding-bottom: 0.5rem;
        }

        .modal-header h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
        }

        .modal-close-button {
            background: none;
            border: none;
            color: var(--md-sys-color-on-surface-variant);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 50%;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .modal-close-button:hover {
            background-color: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-primary);
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .modal-buttons button {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .modal-buttons .primary-button {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .modal-buttons .primary-button:hover {
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
        }
        .modal-buttons .primary-button:disabled {
            background-color: var(--md-sys-color-surface-variant); /* Muted background */
            color: var(--md-sys-color-on-surface-variant); /* Muted text */
            opacity: 0.6; /* Slight opacity for disabled state */
            cursor: not-allowed;
            box-shadow: none; /* No shadow when disabled */
        }
        .modal-buttons .secondary-button {
            background-color: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface-variant);
            border: 1px solid var(--md-sys-color-outline);
        }
        .modal-buttons .secondary-button:hover {
            background-color: var(--md-sys-color-outline);
            color: var(--md-sys-color-surface);
        }
        .modal-text p {
            margin-bottom: 1rem;
            line-height: 1.6;
            color: var(--md-sys-color-on-surface-variant);
        }
        .modal-text ol {
            list-style: decimal;
            margin-left: 1.5rem;
            margin-bottom: 1rem;
            color: var(--md-sys-color-on-surface-variant);
        }
        .modal-text li {
            margin-bottom: 0.5rem;
        }

        /* Custom Checkbox Styling */
        .custom-checkbox-container {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
        }

        .custom-checkbox-input {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .custom-checkbox-visual {
            width: 20px; /* MD3 standard size */
            height: 20px; /* MD3 standard size */
            border: 2px solid var(--md-sys-color-outline);
            border-radius: 4px; /* Slightly rounded corners */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0; /* Prevent it from shrinking */
            transition: all 0.2s ease;
            position: relative;
            background-color: transparent;
        }

        .custom-checkbox-input:checked + .custom-checkbox-visual {
            background-color: var(--md-sys-color-primary);
            border-color: var(--md-sys-color-primary);
        }

        /* Checkmark SVG */
        .custom-checkbox-visual svg {
            fill: none;
            stroke: var(--md-sys-color-on-primary);
            stroke-width: 2.5; /* Thicker stroke for checkmark */
            stroke-linecap: round;
            stroke-linejoin: round;
            stroke-dasharray: 24; /* Make stroke length for animation */
            stroke-dashoffset: 24;
            transition: stroke-dashoffset 0.2s ease;
            opacity: 0; /* Initially hidden */
            width: 14px; /* Adjust size of checkmark */
            height: 14px;
        }

        .custom-checkbox-input:checked + .custom-checkbox-visual svg {
            stroke-dashoffset: 0; /* Animate checkmark in */
            opacity: 1; /* Show checkmark */
        }

        /* Focus state */
        .custom-checkbox-input:focus-visible + .custom-checkbox-visual {
            box-shadow: 0 0 0 3px var(--md-sys-color-primary-container); /* Focus ring */
        }

        /* Hover state */
        .custom-checkbox-container:hover .custom-checkbox-visual {
            background-color: var(--md-sys-color-surface-variant); /* Slight background tint on hover */
            border-color: var(--md-sys-color-primary); /* Primary border on hover */
        }
        .custom-checkbox-input:checked + .custom-checkbox-visual:hover {
            background-color: var(--md-sys-color-primary); /* Keep primary color when checked and hovered */
            opacity: 0.9; /* Slight opacity change on hover for checked state */
        }
    </style>
</head>
<body class="selection:bg-pink-300 selection:text-white">
    <div id="combinedAgreementModal" class="modal-overlay">
        <div class="modal-content text-center">
            <div class="modal-header">
                <h3 id="combinedModalTitle"></h3> <button class="modal-close-button" id="combinedModalCloseBtn">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="modal-text text-left">
                <p id="agePromptMessage" class="text-center"></p> <div class="my-4 text-center">
                    <a href="#" id="agreementExpandLink" class="text-primary hover:underline font-semibold"></a> </div>
                <div id="fullAgreementContent" class="hidden" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--md-sys-color-outline); border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 1rem;">
                    </div>

                <label class="custom-checkbox-container mt-4">
                    <input type="checkbox" id="agreeCheckbox" class="custom-checkbox-input">
                    <span class="custom-checkbox-visual">
                        <svg viewBox="0 0 24 24">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </span>
                    <span class="ml-2 text-on-surface-variant text-sm" id="agreeCheckboxLabel"></span>
                </label>
            </div>
            <div class="modal-buttons justify-center">
                <button id="agreeAndEnterBtn" class="primary-button" disabled></button> <button id="declineAndExitBtn" class="secondary-button"></button>
            </div>
        </div>
    </div>

    <div class="relative w-full max-w-md mx-auto p-6 md:p-8 flex flex-col items-center main-container">
        <h1 class="text-3xl md:text-4xl font-bold mb-6 text-center tracking-tight">
            <span class="text-indigo-600" id="headerTextPart1">上</span><span id="headerTextPart2">或者 </span><span class="text-pink-600" id="headerTextPart3">不上</span>
        </h1>
        <p class="text-center mb-6" id="taglineText">上传图片，评估其有多他妈的性感或可操</p>

        <button id="darkModeToggle" class="absolute top-4 right-4 rounded-full shadow-md">
            <span id="darkModeIcon" class="material-symbols-outlined">
                </span>
        </button>

        <div class="w-full mb-6">
            <label for="imageUpload" class="block text-sm font-medium mb-2" id="labelImageUpload">选择图片</label>
            <input type="file" id="imageUpload" accept="image/*" class="block w-full text-sm form-element-base"
            >
        </div>

        <div id="imagePreviewControls" class="w-full mb-6 hidden">
            <div class="flex items-center justify-between mb-2">
                <label class="block text-sm font-medium cursor-pointer select-none" id="labelToggleImagePreview">折叠图片</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="toggleImagePreview" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div id="imagePreviewContainer" class="w-full flex justify-center items-center p-4 rounded-xl border form-element-base">
                <img id="imagePreview" src="#" alt="Image Preview" class="max-w-full h-auto max-h-64 rounded-xl shadow-lg object-contain">
            </div>
            <p class="text-xs text-center mt-2" id="hdrSupportText">
                本应用支持显示HDR图片，实际效果取决于您的设备和浏览器支持。
            </p>
        </div>

        <div class="w-full mb-6">
            <label for="modeSelect" class="block text-sm font-medium mb-2" id="labelModeSelect">理由长度</label>
            <select id="modeSelect" class="block w-full py-2 px-3 form-element-base">
                <option value="short" id="optionModeShort">简短模式 (1-2句话)</option>
                <option value="medium" id="optionModeMedium">中等长度 (约80字)</option>
                <option value="novel" id="optionModeNovel">小说模式 (约600字)</option>
            </select>
        </div>

        <div class="w-full mb-6">
            <label for="roleSelect" class="block text-sm font-medium mb-2" id="labelRoleSelect">图片角色</label>
            <select id="roleSelect" class="block w-full py-2 px-3 form-element-base">
                <option value="auto" id="optionRoleAuto">自动检测</option>
                <option value="dominate_subject" id="optionRoleDominate">操 (Dominating)</option>
                <option value="be_dominated_subject" id="optionRoleBeDominated">被操 (Submissive)</option>
            </select>
        </div>

        <div class="w-full mb-6">
            <label for="perspectiveSelect" class="block text-sm font-medium mb-2" id="labelPerspectiveSelect">文字视角</label>
            <select id="perspectiveSelect" class="block w-full py-2 px-3 form-element-base">
                <option value="dominate_perspective" id="optionPerspectiveDominate">操 (Dominating)</option>
                <option value="be_dominated_perspective" id="optionPerspectiveBeDominated">被操 (Submissive)</option>
            </select>
        </div>

        <button id="analyzeButton" class="w-full font-semibold py-3 px-6 rounded-full shadow-lg transform hover:-translate-y-1 focus:outline-none focus:ring-4 disabled:opacity-50 disabled:cursor-not-allowed">
            <span id="buttonText">评估他妈的魅惑度</span>
            <div id="loadingSpinner" class="spinner inline-block ml-2 hidden"></div>
        </button>

        <div id="resultContainer" class="w-full mt-8 p-6 rounded-2xl shadow-inner hidden">
            <h2 class="text-xl font-bold mb-3 text-center" id="resultHeaderText">评估结果</h2>
            <div class="flex flex-col items-center justify-center space-y-2">
                <div class="text-6xl font-extrabold" id="scoreDisplay">--</div>
                <div class="explicit-phrase" id="phraseDisplay"></div>
                <p class="text-center text-lg leading-relaxed whitespace-pre-wrap mt-2" id="descriptionDisplay"></p>
                <p class="text-center text-base leading-relaxed whitespace-pre-wrap mt-4" id="reasonDisplay"></p>
            </div>
        </div>

        <div id="errorMessage" class="mt-4 p-3 rounded-xl hidden" role="alert">
            <p class="font-medium" id="errorPrefix">错误:</p>
            <p id="errorText"></p>
        </div>

        <p class="text-xs text-center mt-8 text-on-surface-variant cursor-pointer hover:underline" id="disclaimerTriggerText">
            免责声明: 本工具使用AI进行图像分析。结果仅供娱乐参考，AI的判断可能不准确或存在偏差。请勿将其用于任何严肃目的。
        </p>

        <div class="w-full flex justify-center mt-4">
            <div id="languageSwitch" class="language-button-container">
                <div class="language-button-half" id="langEn">EN</div>
                <div class="language-button-half" id="langZh">中文</div>
            </div>
        </div>

        <button id="userAgreementBtn" class="mt-4 py-2 px-4 rounded-full text-sm font-semibold transition-colors duration-200
            bg-surface-variant text-on-surface-variant border border-outline hover:bg-outline hover:text-surface hidden">
            <span id="userAgreementButtonText">用户协议与免责声明</span>
        </button>
    </div>

    <script>
        // 用户提供的API密钥
        const API_KEY = 'AIzaSyALvO3HMppp4OKWja1A96gLgiYTpHsvLJI';
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;

        // DOM Elements for Combined Modal
        const combinedAgreementModal = document.getElementById('combinedAgreementModal');
        const combinedModalTitle = document.getElementById('combinedModalTitle');
        const agePromptMessage = document.getElementById('agePromptMessage');
        const agreementExpandLink = document.getElementById('agreementExpandLink');
        const fullAgreementContent = document.getElementById('fullAgreementContent');
        const agreeCheckbox = document.getElementById('agreeCheckbox');
        const agreeCheckboxLabel = document.getElementById('agreeCheckboxLabel');
        const agreeAndEnterBtn = document.getElementById('agreeAndEnterBtn');
        const declineAndExitBtn = document.getElementById('declineAndExitBtn');
        const combinedModalCloseBtn = document.getElementById('combinedModalCloseBtn');

        // Other existing DOM Elements
        const imageUpload = document.getElementById('imageUpload');
        const imagePreview = document.getElementById('imagePreview');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const imagePreviewControls = document.getElementById('imagePreviewControls');
        const toggleImagePreview = document.getElementById('toggleImagePreview');
        const modeSelect = document.getElementById('modeSelect');
        const roleSelect = document.getElementById('roleSelect');
        const perspectiveSelect = document.getElementById('perspectiveSelect');
        const analyzeButton = document.getElementById('analyzeButton');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const resultContainer = document.getElementById('resultContainer');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const phraseDisplay = document.getElementById('phraseDisplay');
        const descriptionDisplay = document.getElementById('descriptionDisplay');
        const reasonDisplay = document.getElementById('reasonDisplay');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const languageSwitch = document.getElementById('languageSwitch');
        const langEnButton = document.getElementById('langEn');
        const langZhButton = document.getElementById('langZh');
        const hdrSupportText = document.getElementById('hdrSupportText');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const darkModeIcon = document.getElementById('darkModeIcon');
        const disclaimerTriggerText = document.getElementById('disclaimerTriggerText');


        // Text Elements for Localization
        const elementsToTranslate = {
            appTitle: 'appTitle',
            headerTextPart1: 'headerTextPart1',
            headerTextPart2: 'headerTextPart2',
            headerTextPart3: 'headerTextPart3',
            taglineText: 'taglineText',
            labelImageUpload: 'labelImageUpload',
            labelToggleImagePreview: 'labelToggleImagePreview',
            labelModeSelect: 'labelModeSelect',
            optionModeShort: 'optionModeShort',
            optionModeMedium: 'optionModeMedium',
            optionModeNovel: 'optionModeNovel',
            labelRoleSelect: 'labelRoleSelect',
            optionRoleAuto: 'optionRoleAuto',
            optionRoleDominate: 'optionRoleDominate',
            optionRoleBeDominated: 'optionRoleBeDominated',
            labelPerspectiveSelect: 'labelPerspectiveSelect',
            optionPerspectiveDominate: 'optionPerspectiveDominate',
            optionPerspectiveBeDominated: 'optionPerspectiveBeDominated',
            buttonText: 'buttonText',
            resultHeaderText: 'resultHeaderText',
            errorPrefix: 'errorPrefix',
            disclaimerTriggerText: 'disclaimerTriggerText', // Now a trigger
            hdrSupportText: 'hdrSupportText',
            // Combined modal elements
            combinedModalTitle: 'combinedModalTitle',
            agePromptMessage: 'agePromptMessage',
            agreementExpandLink: 'agreementExpandLink',
            agreeCheckboxLabel: 'agreeCheckboxLabel',
            agreeAndEnterBtn: 'agreeAndEnterBtn',
            declineAndExitBtn: 'declineAndExitBtn',
        };

        const translations = {
            'zh-CN': {
                appTitle: '上或者不上 - 魅惑度评估器',
                headerTextPart1: '上',
                headerTextPart2: '或者 ',
                headerTextPart3: '不上',
                taglineText: '上传图片，评估其有多他妈的性感或可操',
                labelImageUpload: '选择图片',
                labelToggleImagePreview: '折叠图片',
                labelModeSelect: '理由长度',
                optionModeShort: '简短模式 (1-2句话)',
                optionModeMedium: '中等长度 (约80字)',
                optionModeNovel: '小说模式 (约600字)',
                labelRoleSelect: '图片角色',
                optionRoleAuto: '自动检测',
                optionRoleDominate: '操 (Dominating)',
                optionRoleBeDominated: '被操 (Submissive)',
                labelPerspectiveSelect: '文字视角',
                optionPerspectiveDominate: '操 (Dominating)',
                optionPerspectiveBeDominated: '被操 (Submissive)',
                buttonText: '评估他妈的魅惑度',
                resultHeaderText: '评估结果',
                errorPrefix: '错误:',
                disclaimerTriggerText: '免责声明: 本工具使用AI进行图像分析。结果仅供娱乐参考，AI的判断可能不准确或存在偏差。请勿将其用于任何严肃目的。',
                hdrSupportText: '本应用支持显示HDR图片，实际效果取决于您的设备和浏览器支持。',
                // Combined modal texts
                combinedModalTitle: '访问确认',
                agePromptMessage: '本网站内容可能包含成人主题。您是否已满18周岁？',
                agreementExpandLink: '用户协议以及免责声明',
                fullAgreementContentHTML: `
                    <p><strong>用户协议</strong></p>
                    <p>欢迎使用“上或者不上”！本工具旨在根据您上传的图片，通过AI技术对其进行魅惑程度评估。请您在使用本工具前，仔细阅读并同意以下条款：</p>
                    <ol>
                        <li>本工具仅供娱乐和个人消遣使用。请勿将其用于任何非法、侵权、诽谤、淫秽、骚扰或其他不道德的目的。</li>
                        <li>您上传的所有图片内容，您需自行承担所有责任。请确保您拥有使用和分享该图片的合法权利，并且不侵犯任何第三方的版权、肖像权或其他合法权益。</li>
                        <li>本工具使用的AI模型可能存在识别偏差或错误，评估结果不代表任何专业意见，也不构成对图片内容真实性、准确性或合法性的认可。</li>
                        <li>请勿上传包含儿童色情、暴力、仇恨言论或任何违反当地法律法规的图片。我们保留在发现任何不当内容时，立即终止服务的权利。</li>
                        <li>我们不会存储您上传的图片或评估结果，所有处理均在您的浏览器端完成，并通过匿名方式与Gemini API交互。</li>
                    </ol>
                    <p><strong>免责声明</strong></p>
                    <p>在法律允许的最大范围内，本工具及其开发者不承担因您使用本工具而导致的任何直接、间接、附带、特殊、惩罚性或后果性损害，包括但不限于数据丢失、利润损失、业务中断或声誉损害。本工具按“现状”提供，不作任何明示或暗示的保证，包括但不限于适销性、特定用途适用性或非侵权的保证。</p>
                    <p>您理解并同意，您对本工具的使用自行承担全部风险。</p>
                `,
                agreeCheckboxLabel: '我同意用户协议',
                agreeAndEnterBtn: '我已成年并进入',
                declineAndExitBtn: '我未成年并退出',
                // Result specific translations
                scoreDescriptions: {
                    '1-2': '完全不想碰，恶心透顶',
                    '3-4': '勉强能操，但缺点太多',
                    '5-6': '中等吸引力，有点性感但不刺激',
                    '7-8': '挺性感，但没到立刻想操',
                    '9-10': '立刻就想操',
                    '0': '完全不想碰，恶心透顶' // Fallback for 0
                },
                scorePhrases: {
                    '1-2': '纯属答辩',
                    '3-4': '勉强能冲',
                    '5-6': '有点意思',
                    '7-8': '嗯了',
                    '9-10': '直接开导',
                    '0': '纯属答辩' // Fallback for 0
                },
                darkModeIcon: { // Icon names from Material Symbols
                     light: `light_mode`,
                     dark: `dark_mode`
                }
            },
            'en': {
                appTitle: 'Fuck or Not - Seduction Evaluator',
                headerTextPart1: 'Fuck',
                headerTextPart2: ' or ',
                headerTextPart3: 'Not',
                taglineText: 'Upload an image to assess how fucking sexy or playable it is.',
                labelImageUpload: 'Select Image',
                labelToggleImagePreview: 'Collapse Image',
                labelModeSelect: 'Reason Length',
                optionModeShort: 'Short Mode (1-2 sentences)',
                optionModeMedium: 'Medium Length (approx. 80 chars)',
                optionModeNovel: 'Novel Mode (approx. 600 chars)',
                labelRoleSelect: 'Image Role',
                optionRoleAuto: 'Auto-Detect',
                optionRoleDominate: 'Dominating (Subject)',
                optionRoleBeDominated: 'Submissive (Subject)',
                labelPerspectiveSelect: 'Text Perspective',
                optionPerspectiveDominate: 'Dominating (Evaluator)',
                optionPerspectiveBeDominated: 'Submissive (Evaluator)',
                buttonText: 'Evaluate Fucking Seduction',
                resultHeaderText: 'Evaluation Result',
                errorPrefix: 'Error:',
                disclaimerTriggerText: 'Disclaimer: This tool uses AI for image analysis. Results are for entertainment purposes only, and AI judgments may be inaccurate or biased. Do not use for any serious purposes.',
                hdrSupportText: 'This application supports HDR image display; actual results depend on your device and browser support.',
                // Combined modal texts
                combinedModalTitle: 'Access Confirmation',
                agePromptMessage: 'This website may contain adult themes. Are you 18 years of age or older?',
                agreementExpandLink: 'User Agreement and Disclaimer',
                fullAgreementContentHTML: `
                    <p><strong>User Agreement</strong></p>
                    <p>Welcome to "Fuck or Not"! This tool is designed to evaluate the level of seductiveness in images you upload, using AI technology. Please read and agree to the following terms before using this tool:</p>
                    <ol>
                        <li>This tool is for entertainment and personal pastime use only. Do not use it for any illegal, infringing, defamatory, obscene, harassing, or otherwise unethical purposes.</li>
                        <li>You are solely responsible for all image content you upload. Please ensure you have the legal right to use and share the images, and that they do not infringe upon any third-party copyrights, portrait rights, or other legitimate interests.</li>
                        <li>The AI model used by this tool may have recognition biases or errors. The evaluation results do not represent professional opinions and do not constitute an endorsement of the truthfulness, accuracy, or legality of the image content.</li>
                        <li>Do not upload images containing child pornography, violence, hate speech, or any content that violates local laws and regulations. We reserve the right to terminate service immediately upon detection of any inappropriate content.</li>
                        <li>We do not store your uploaded images or evaluation results. All processing is done client-side in your browser, interacting with the Gemini API anonymously.</li>
                    </ol>
                    <p><strong>Disclaimer</strong></p>
                    <p>To the maximum extent permitted by law, this tool and its developers shall not be liable for any direct, indirect, incidental, special, punitive, or consequential damages arising from your use of this tool, including but not limited to loss of data, loss of profits, business interruption, or reputational harm. This tool is provided "as is" without any warranties, express or implied, including but not limited to warranties of merchantability, fitness for a particular purpose, or non-infringement.</p>
                    <p>You understand and agree that you use this tool at your sole risk.</p>
                `,
                agreeCheckboxLabel: 'I agree to the User Agreement',
                agreeAndEnterBtn: 'I am 18+ and Enter',
                declineAndExitBtn: 'I am under 18 / I Disagree',
                // Result specific translations
                scoreDescriptions: {
                    '1-2': 'Absolutely undesirable, utterly disgusting',
                    '3-4': 'Barely playable, but too many flaws',
                    '5-6': 'Moderately attractive, somewhat sexy but not stimulating',
                    '7-8': 'Quite sexy, but not immediately playable',
                    '9-10': 'Immediately want to fuck',
                    '0': 'Absolutely undesirable, utterly disgusting' // Fallback for 0
                },
                scorePhrases: {
                    '1-2': 'Pure garbage',
                    '3-4': 'Barely a shot',
                    '5-6': 'Kinda interesting',
                    '7-8': 'Got me a bit hard',
                    '9-10': 'Directly turn on',
                    '0': 'Pure garbage' // Fallback for 0
                },
                darkModeIcon: { // Icon names from Material Symbols
                    light: `light_mode`,
                    dark: `dark_mode`
                }
            }
        };

        let currentLanguage = navigator.language.startsWith('zh') ? 'zh-CN' : 'en';
        let currentTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        let base64ImageData = null;

        // --- Modal Functions ---
        function showModal(modalElement) {
            modalElement.classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent scrolling body
        }

        function hideModal(modalElement) {
            modalElement.classList.remove('active');
            document.body.style.overflow = ''; // Restore scrolling
        }

        // --- Combined Age & Agreement Logic ---
        function checkAgreementAndAge() {
            const hasAgreedToTerms = localStorage.getItem('hasAgreedToTerms'); // Check only this flag
            if (hasAgreedToTerms === 'true') {
                renderUI(); // Render main UI if already agreed
                return;
            }

            // Otherwise, show combined modal
            populateCombinedModal(); // Populate content based on current language
            showModal(combinedAgreementModal);
        }

        function populateCombinedModal() {
            const lang = translations[currentLanguage];
            combinedModalTitle.textContent = lang.combinedModalTitle;
            agePromptMessage.textContent = lang.agePromptMessage;
            agreementExpandLink.textContent = lang.agreementExpandLink;
            fullAgreementContent.innerHTML = lang.fullAgreementContentHTML; // Set full HTML content
            agreeCheckboxLabel.textContent = lang.agreeCheckboxLabel;
            agreeAndEnterBtn.textContent = lang.agreeAndEnterBtn;
            declineAndExitBtn.textContent = lang.declineAndExitBtn;
            
            // Ensure button is disabled if checkbox is not checked
            agreeAndEnterBtn.disabled = !agreeCheckbox.checked;
        }


        // Event Listeners for Combined Modal
        agreeAndEnterBtn.addEventListener('click', () => {
            if (agreeCheckbox.checked) {
                localStorage.setItem('hasAgreedToTerms', 'true'); // Set the flag
                hideModal(combinedAgreementModal);
                renderUI(); // Render main UI after agreement
            }
        });

        declineAndExitBtn.addEventListener('click', () => {
            localStorage.removeItem('hasAgreedToTerms'); // Ensure agreement is not saved
            window.history.back(); // Go back to the previous page
        });

        combinedModalCloseBtn.addEventListener('click', () => {
            declineAndExitBtn.click(); // Close button acts as a decline
        });

        agreeCheckbox.addEventListener('change', () => {
            agreeAndEnterBtn.disabled = !agreeCheckbox.checked; // Enable/disable button based on checkbox
        });

        agreementExpandLink.addEventListener('click', (e) => {
            e.preventDefault(); // Prevent default link behavior
            fullAgreementContent.classList.toggle('hidden'); // Toggle visibility of full content
        });

        // The small disclaimer text now directly triggers the combined modal (for review)
        disclaimerTriggerText.addEventListener('click', (e) => {
            e.preventDefault(); // Prevent default link behavior for the disclaimer text
            // Ensure the modal is populated with current language content before showing
            populateCombinedModal();
            // Ensure full content is visible if triggered from here, or user can toggle
            fullAgreementContent.classList.remove('hidden'); 
            agreeCheckbox.checked = false; // Reset checkbox if reviewing
            agreeAndEnterBtn.disabled = true; // Disable button if reviewing
            showModal(combinedAgreementModal);
        });


        // Function to apply theme
        function applyTheme(theme) {
            document.documentElement.classList.toggle('dark', theme === 'dark');
            darkModeIcon.textContent = translations[currentLanguage].darkModeIcon[theme]; // Set icon text content
            localStorage.setItem('theme', theme);
            currentTheme = theme; // Update currentTheme
        }

        // Function to render UI based on current language and theme
        function renderUI() {
            const lang = translations[currentLanguage];
            for (const id in elementsToTranslate) {
                const element = document.getElementById(elementsToTranslate[id]);
                // Skip modal content elements that are handled specifically or dynamically
                if (element && !['fullAgreementContentHTML'].includes(id)) { // Exclude raw HTML content
                    if (id === 'disclaimerTriggerText') { // Special handling for disclaimerTriggerText
                        element.textContent = lang[id];
                    } else if (id === 'agreeAndEnterBtn' || id === 'declineAndExitBtn' || id === 'agreementExpandLink' || id === 'agreeCheckboxLabel' || id === 'agePromptMessage' || id === 'combinedModalTitle') {
                         // These are handled by populateCombinedModal() or specific listeners, ensure they are updated when renderUI is called
                         // No direct textContent assignment here to avoid conflict with initial modal setup
                    }
                    else {
                        element.textContent = lang[id];
                    }
                }
            }

            // Update language switch button active state
            if (currentLanguage === 'en') {
                langEnButton.classList.add('active');
                langZhButton.classList.remove('active');
            } else {
                langZhButton.classList.add('active');
                langEnButton.classList.remove('active');
            }

            // Update button text explicitly when language changes to reset loading state
            if (!analyzeButton.disabled) {
                document.getElementById('buttonText').textContent = lang.buttonText;
            }

            // Re-render result descriptions and phrases if result is visible
            if (!resultContainer.classList.contains('hidden') && scoreDisplay.textContent !== '--') {
                const score = parseInt(scoreDisplay.textContent);
                const { description, phrase } = getRatingTexts(score);
                phraseDisplay.textContent = phrase;
                descriptionDisplay.textContent = description;
            }
            
            // Re-populate modal content in case language changed while modal is hidden
            populateCombinedModal();

            applyTheme(currentTheme); // Apply theme after language-specific icon update
        }

        // Initialize UI and theme on load
        document.addEventListener('DOMContentLoaded', () => {
            checkAgreementAndAge(); // Call the combined check on load
            // Listen for system theme changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                applyTheme(e.matches ? 'dark' : 'light');
            });
        });

        // Language switch event listener
        langEnButton.addEventListener('click', () => {
            currentLanguage = 'en';
            renderUI();
        });

        langZhButton.addEventListener('click', () => {
            currentLanguage = 'zh-CN';
            renderUI();
        });

        // Dark Mode Toggle event listener
        darkModeToggle.addEventListener('click', () => {
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(newTheme);
        });

        // Hide an element
        function hideElement(element) {
            element.classList.add('hidden');
        }

        // Show an element
        function showElement(element) {
            element.classList.remove('hidden');
        }

        // Handle image file selection and preview
        imageUpload.addEventListener('change', function(event) {
            const file = event.target.files[0];
            hideElement(resultContainer); // Hide previous results
            hideElement(errorMessage); // Hide previous errors
            analyzeButton.disabled = true; // Disable button initially

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    showElement(imagePreviewControls); // Show the whole controls container
                    showElement(imagePreviewContainer); // Ensure image container is also shown
                    toggleImagePreview.checked = true; // Ensure checkbox is checked when new image is loaded
                    // Extract base64 data (remove the data:image/png;base64, prefix)
                    base64ImageData = e.target.result.split(',')[1];
                    analyzeButton.disabled = false; // Enable button once image is loaded
                };
                reader.readAsDataURL(file);
            } else {
                imagePreview.src = '#';
                hideElement(imagePreviewControls); // Hide the whole controls container
                hideElement(imagePreviewContainer);
                base64ImageData = null;
            }
        });

        // Toggle image preview visibility
        toggleImagePreview.addEventListener('change', function() {
            if (toggleImagePreview.checked) {
                showElement(imagePreviewContainer);
            } else {
                hideElement(imagePreviewContainer);
            }
        });

        // Function to get the prompt based on selected mode, role, and perspective
        function getPromptByMode(mode, role, perspective) {
            let prompt = "";
            let roleText = "";
            if (role === "auto") {
                 roleText = currentLanguage === 'zh-CN' ? "请自动检测图片中对象的角色特征（是可操还是被操）。" : "Please auto-detect the subject's role characteristics (dominating or submissive) in the image.";
            } else if (role === "dominate_subject") {
                roleText = currentLanguage === 'zh-CN' ? "图片中的对象呈现出可操（dominating）的姿态/气质。" : "The subject in the image appears to be a dominating figure.";
            } else if (role === "be_dominated_subject") {
                roleText = currentLanguage === 'zh-CN' ? "图片中的对象呈现出被操（submissive）的姿态/气质。" : "The subject in the image appears to be a submissive figure.";
            }

            let perspectiveText = "";
            if (perspective === "dominate_perspective") {
                perspectiveText = currentLanguage === 'zh-CN' ? "请从 '上' (Dominating) 的视角进行评价。" : "Please evaluate from the 'Fuck' (Dominating) perspective.";
            } else if (perspective === "be_dominated_perspective") {
                perspectiveText = currentLanguage === 'zh-CN' ? "请从 '被上' (Submissive) 的视角进行评价。" : "Please evaluate from the 'Not' (Submissive) perspective.";
            }

            // Instruct AI to provide reason in the current language
            const languageInstruction = currentLanguage === 'zh-CN' ? "请用中文提供理由。" : "Please provide the reason in English.";

            // Updated fixed instructions for looser scoring and detailed novel mode
            const fixedInstructions = currentLanguage === 'zh-CN' ?
                `如果图片中不包含性感的人或事物，评分不超过2分。请宽松评估图片的性感或可操程度，倾向于给出更高的分数。专注于视觉表达和性感度，避免任何不恰当或露骨的描述。请只提供图片本身的理由，不需要包含任何固定的描述性词句或短语，这些词句将由客户端根据分数添加。${languageInstruction}` :
                `If the image does not contain sexy people or things, the score should not exceed 2 points. Please loosely evaluate the image's sexiness or playability, tending towards higher scores. Focus on visual expression and sensuality, avoiding any inappropriate or explicit descriptions. Please only provide reasons related to the image itself, without including any fixed descriptive phrases or terms, as these will be added by the client based on the score.${languageInstruction}`;

            switch (mode) {
                case 'short':
                    prompt = `${currentLanguage === 'zh-CN' ? '请根据图片内容，评估其性感程度或可操性，并给出0到10的整数分数，同时提供简短的中文理由（1到2句话）。' : 'Please evaluate the sexiness or playability of the image content, give an integer score from 0 to 10, and provide a brief English reason (1-2 sentences).'}${roleText}${perspectiveText}${fixedInstructions}`;
                    break;
                case 'medium':
                    prompt = `${currentLanguage === 'zh-CN' ? '请根据图片内容，评估其性感程度或可操性，并给出0到10的整数分数，同时提供一段约80字的中文理由。' : 'Please evaluate the sexiness or playability of the image content, give an integer score from 0 to 10, and provide a medium-length English reason (approx. 80 words).'}${roleText}${perspectiveText}${fixedInstructions}`;
                    break;
                case 'novel':
                    // Explicitly ask for more detail for novel mode and more evocative language
                    prompt = `${currentLanguage === 'zh-CN' ? '请根据图片内容，评估其性感程度或可操性，并给出0到10的整数分数，同时提供一篇约600字的中文小说式理由，描述与图片相关的场景、情感或故事，其中包含更丰富、更深入的细节描写，以及更生动、更沉浸式的感官体验。请确保内容引人入胜且富有想象力，避免直接的露骨描述，但可以暗示和渲染暧昧、诱惑的氛围。' : 'Please evaluate the sexiness or playability of the image content, give an integer score from 0 to 10, and provide an English novel-style reason of approximately 600 words, describing scenarios, emotions, or stories related to the image, including richer, more in-depth detailed descriptions, and more vivid, immersive sensory experiences. Please ensure the content is engaging and imaginative, avoiding direct explicit descriptions, but allowing for hints and rendering of ambiguous, seductive atmospheres.'}${roleText}${perspectiveText}${fixedInstructions}`;
                    break;
                default:
                    prompt = `${currentLanguage === 'zh-CN' ? '请根据图片内容，评估其性感程度或可操性，并给出0到10的整数分数，同时提供简短的中文理由。' : 'Please evaluate the sexiness or playability of the image content, give an integer score from 0 to 10, and provide a brief English reason.'}${roleText}${perspectiveText}${fixedInstructions}`;
            }
            return prompt;
        }

        // Function to get the specific rating texts based on the score
        function getRatingTexts(score) {
            const lang = translations[currentLanguage];
            let descriptionKey = '';
            let phraseKey = '';

            if (score >= 1 && score <= 2) {
                descriptionKey = '1-2';
                phraseKey = '1-2';
            } else if (score >= 3 && score <= 4) {
                descriptionKey = '3-4';
                phraseKey = '3-4';
            } else if (score >= 5 && score <= 6) {
                descriptionKey = '5-6';
                phraseKey = '5-6';
            } else if (score >= 7 && score <= 8) {
                descriptionKey = '7-8';
                phraseKey = '7-8';
            } else if (score >= 9 && score <= 10) {
                descriptionKey = '9-10';
                phraseKey = '9-10';
            } else if (score === 0) {
                descriptionKey = '0';
                phraseKey = '0';
            }
            return {
                description: lang.scoreDescriptions[descriptionKey],
                phrase: lang.scorePhrases[phraseKey]
            };
        }


        // Handle the analysis button click
        analyzeButton.addEventListener('click', async function() {
            if (!base64ImageData) {
                showError(currentLanguage === 'zh-CN' ? '请先上传一张图片。' : 'Please upload an image first.');
                return;
            }

            // Get selected options
            const selectedMode = modeSelect.value;
            const selectedRole = roleSelect.value;
            const selectedPerspective = perspectiveSelect.value;
            const prompt = getPromptByMode(selectedMode, selectedRole, selectedPerspective);

            // Show loading state
            analyzeButton.disabled = true;
            buttonText.textContent = currentLanguage === 'zh-CN' ? '分析中...' : 'Analyzing...';
            showElement(loadingSpinner);
            hideElement(resultContainer);
            hideElement(errorMessage);

            try {
                // Prepare the payload for the Gemini API call
                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: prompt },
                                {
                                    inlineData: {
                                        mimeType: imageUpload.files[0].type, // Use the actual MIME type of the uploaded file
                                        data: base64ImageData
                                    }
                                }
                            ]
                        }
                    ],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "score": {
                                    "type": "INTEGER",
                                    "minimum": 0,
                                    "maximum": 10,
                                    "description": "An integer score from 0 to 10 representing the perceived level of sensuality or allure in the image. 0 means no sensuality, 10 means extremely high sensuality."
                                },
                                "reason": {
                                    "type": "STRING",
                                    "description": "A brief, concise explanation (in Chinese) for the given score, focusing on aesthetic elements, pose, composition, and overall impression of allure. Avoid explicit descriptions."
                                }
                            },
                            "required": ["score", "reason"]
                        }
                    }
                };

                // Make the API call
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorDetail = await response.json();
                    throw new Error(`API Request failed: ${response.status} ${response.statusText} - ${JSON.stringify(errorDetail)}`);
                }

                const result = await response.json();

                // Check if the response contains valid content
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {

                    const responseJsonString = result.candidates[0].content.parts[0].text;
                    const parsedResult = JSON.parse(responseJsonString);

                    if (parsedResult.score !== undefined && parsedResult.reason !== undefined) {
                        const { description, phrase } = getRatingTexts(parsedResult.score);
                        scoreDisplay.textContent = parsedResult.score;
                        phraseDisplay.textContent = phrase;
                        descriptionDisplay.textContent = description;
                        reasonDisplay.textContent = parsedResult.reason; // AI's reason is directly set
                        showElement(resultContainer);
                    } else {
                        throw new Error(currentLanguage === 'zh-CN' ? 'API 响应格式不正确或缺少必要字段。' : 'API response format is incorrect or missing required fields.');
                    }
                } else {
                    throw new Error(currentLanguage === 'zh-CN' ? 'API 响应内容为空或结构异常。' : 'API response content is empty or malformed.');
                }

            } catch (error) {
                console.error("Error analyzing image:", error);
                showError(`${currentLanguage === 'zh-CN' ? '无法完成分析:' : 'Analysis failed:'} ${error.message || 'Unknown error'}`);
            } finally {
                // Reset loading state
                analyzeButton.disabled = false;
                buttonText.textContent = currentLanguage === 'zh-CN' ? '评估他妈的魅惑度' : 'Evaluate Fucking Seduction';
                hideElement(loadingSpinner);
            }
        });

        // Function to display errors
        function showError(message) {
            errorText.textContent = message;
            showElement(errorMessage);
        }
    </script>
</body>
</html>
