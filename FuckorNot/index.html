<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="appTitle">上或者不上 - 魅惑度评估器</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom right, #6366F1, #EC4899); /* Violet to Pink Gradient */
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        /* Custom scrollbar for better aesthetics, iOS-like */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        /* Custom styles for the explicit phrases */
        .explicit-phrase {
            font-size: 2.25rem; /* text-4xl equivalent */
            line-height: 2.5rem; /* leading-10 equivalent */
            font-weight: 800; /* font-extrabold equivalent */
            color: #DB2777; /* pink-600 equivalent */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2); /* subtle shadow */
        }

        /* Custom toggle switch styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px; /* Slightly wider for iOS feel */
            height: 24px; /* Standard iOS switch height */
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 34px; /* Make it round */
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px; /* Slightly smaller than slider height */
            width: 18px; /* Square for circle */
            left: 3px; /* Offset from left */
            bottom: 3px; /* Offset from bottom */
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%; /* Make it circular */
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        input:checked + .slider {
            background-color: #6366F1; /* Indigo color when checked */
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #6366F1;
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(20px); /* Move 20px to the right */
            -ms-transform: translateX(20px);
            transform: translateX(20px);
        }

        /* Language Switch Button Styles */
        .language-button-container {
            display: flex;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 9999px; /* rounded-full */
            overflow: hidden;
            background-color: #f3f4f6; /* gray-100 */
            width: 100%; /* Make it full width */
            max-width: 200px; /* Limit max width for aesthetics */
        }

        .language-button-half {
            padding: 0.5rem 1rem; /* py-2 px-4 */
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem;
            color: #4b5563; /* gray-700 */
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            flex-grow: 1; /* Make them take equal space */
            text-align: center;
            user-select: none; /* Prevent text selection */
            font-weight: 500; /* Medium weight */
        }

        .language-button-half.active {
            background-color: #6366F1; /* indigo-500 */
            color: #ffffff; /* white */
            font-weight: 600; /* font-semibold */
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); /* subtle inset shadow */
        }
    </style>
</head>
<body class="selection:bg-pink-300 selection:text-white">
    <div class="relative w-full max-w-md mx-auto bg-white/80 backdrop-blur-xl rounded-3xl shadow-2xl p-6 md:p-8 flex flex-col items-center border border-white/30">
        <!-- iOS-like Header -->
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-6 text-center tracking-tight">
            <span class="text-indigo-600" id="headerTextPart1">上</span><span id="headerTextPart2">或者 </span><span class="text-pink-600" id="headerTextPart3">不上</span>
        </h1>
        <p class="text-gray-600 text-center mb-6" id="taglineText">上传图片，评估其有多他妈的性感或可操</p>

        <!-- Image Upload Area -->
        <div class="w-full mb-6">
            <label for="imageUpload" class="block text-sm font-medium text-gray-700 mb-2" id="labelImageUpload">选择图片</label>
            <input type="file" id="imageUpload" accept="image/*" class="block w-full text-sm text-gray-500
                file:mr-4 file:py-2 file:px-4
                file:rounded-full file:border-0
                file:text-sm file:font-semibold
                file:bg-indigo-50 file:text-indigo-700
                hover:file:bg-indigo-100 cursor-pointer transition-colors duration-200"
            >
        </div>

        <!-- Image Preview and Collapse (Initially Hidden) -->
        <div id="imagePreviewControls" class="w-full mb-6 hidden">
            <div class="flex items-center justify-between mb-2">
                <label class="block text-sm font-medium text-gray-700 cursor-pointer select-none" id="labelToggleImagePreview">折叠图片</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="toggleImagePreview" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div id="imagePreviewContainer" class="w-full flex justify-center items-center p-4 bg-gray-100 rounded-2xl border border-gray-200">
                <img id="imagePreview" src="#" alt="Image Preview" class="max-w-full h-auto max-h-64 rounded-xl shadow-lg object-contain">
            </div>
            <p class="text-xs text-gray-500 text-center mt-2" id="hdrSupportText">
                本应用支持显示HDR图片，实际效果取决于您的设备和浏览器支持。
            </p>
        </div>

        <!-- Mode Selection -->
        <div class="w-full mb-6">
            <label for="modeSelect" class="block text-sm font-medium text-gray-700 mb-2" id="labelModeSelect">理由长度</label>
            <select id="modeSelect" class="block w-full py-2 px-3 border border-gray-300 bg-white rounded-xl shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                <option value="short" id="optionModeShort">简短模式 (1-2句话)</option>
                <option value="medium" id="optionModeMedium">中等长度 (约80字)</option>
                <option value="novel" id="optionModeNovel">小说模式 (约600字)</option>
            </select>
        </div>

        <!-- Image Role Selection -->
        <div class="w-full mb-6">
            <label for="roleSelect" class="block text-sm font-medium text-gray-700 mb-2" id="labelRoleSelect">图片角色</label>
            <select id="roleSelect" class="block w-full py-2 px-3 border border-gray-300 bg-white rounded-xl shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                <option value="auto" id="optionRoleAuto">自动检测</option>
                <option value="dominate_subject" id="optionRoleDominate">操 (Dominating)</option>
                <option value="be_dominated_subject" id="optionRoleBeDominated">被操 (Submissive)</option>
            </select>
        </div>

        <!-- Perspective Selection -->
        <div class="w-full mb-6">
            <label for="perspectiveSelect" class="block text-sm font-medium text-gray-700 mb-2" id="labelPerspectiveSelect">文字视角</label>
            <select id="perspectiveSelect" class="block w-full py-2 px-3 border border-gray-300 bg-white rounded-xl shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                <option value="dominate_perspective" id="optionPerspectiveDominate">操 (Dominating)</option>
                <option value="be_dominated_perspective" id="optionPerspectiveBeDominated">被操 (Submissive)</option>
            </select>
        </div>

        <!-- Action Button -->
        <button id="analyzeButton" class="w-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:shadow-xl
            transform hover:-translate-y-1 transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-indigo-300 disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
        >
            <span id="buttonText">评估他妈的魅惑度</span>
            <div id="loadingSpinner" class="spinner inline-block ml-2 hidden"></div>
        </button>

        <!-- Result Display Area -->
        <div id="resultContainer" class="w-full mt-8 p-6 bg-purple-50/70 rounded-2xl shadow-inner border border-purple-200 hidden">
            <h2 class="text-xl font-bold text-purple-800 mb-3 text-center" id="resultHeaderText">评估结果</h2>
            <div class="flex flex-col items-center justify-center space-y-2">
                <div class="text-6xl font-extrabold text-pink-600" id="scoreDisplay">--</div>
                <div class="explicit-phrase" id="phraseDisplay"></div> 
                <p class="text-gray-700 text-center text-lg leading-relaxed whitespace-pre-wrap mt-2" id="descriptionDisplay"></p>
                <p class="text-gray-700 text-center text-base leading-relaxed whitespace-pre-wrap mt-4" id="reasonDisplay"></p>
            </div>
        </div>

        <!-- Error Message Container -->
        <div id="errorMessage" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-xl hidden" role="alert">
            <p class="font-medium" id="errorPrefix">错误:</p>
            <p id="errorText"></p>
        </div>

        <!-- Disclaimer -->
        <p class="text-xs text-gray-500 text-center mt-8" id="disclaimerText">
            <span class="font-bold" id="disclaimerPrefix">免责声明:</span> 本工具使用AI进行图像分析。结果仅供娱乐参考，AI的判断可能不准确或存在偏差。请勿将其用于任何严肃目的。
            此API密钥直接嵌入在客户端代码中，不建议在生产环境中使用。
        </p>

        <!-- Language Switch -->
        <div class="w-full flex justify-center mt-4">
            <div id="languageSwitch" class="language-button-container">
                <div class="language-button-half" id="langEn">EN</div>
                <div class="language-button-half" id="langZh">中文</div>
            </div>
        </div>
    </div>

    <script>
        // User provided API Key
        const API_KEY = 'AIzaSyALvO3HMppp4OKWja1A96gLgiYTpHsvLJI';
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;

        // DOM Elements
        const imageUpload = document.getElementById('imageUpload');
        const imagePreview = document.getElementById('imagePreview');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const imagePreviewControls = document.getElementById('imagePreviewControls'); // Container for image preview and toggle
        const toggleImagePreview = document.getElementById('toggleImagePreview');
        const modeSelect = document.getElementById('modeSelect');
        const roleSelect = document.getElementById('roleSelect');
        const perspectiveSelect = document.getElementById('perspectiveSelect');
        const analyzeButton = document.getElementById('analyzeButton');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const resultContainer = document.getElementById('resultContainer');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const phraseDisplay = document.getElementById('phraseDisplay');
        const descriptionDisplay = document.getElementById('descriptionDisplay');
        const reasonDisplay = document.getElementById('reasonDisplay');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const languageSwitch = document.getElementById('languageSwitch'); // Parent container for language buttons
        const langEnButton = document.getElementById('langEn'); // EN button
        const langZhButton = document.getElementById('langZh'); // ZH button
        const hdrSupportText = document.getElementById('hdrSupportText'); // HDR support text element


        // Text Elements for Localization
        const elementsToTranslate = {
            appTitle: 'appTitle',
            headerTextPart1: 'headerTextPart1',
            headerTextPart2: 'headerTextPart2',
            headerTextPart3: 'headerTextPart3',
            taglineText: 'taglineText',
            labelImageUpload: 'labelImageUpload',
            labelToggleImagePreview: 'labelToggleImagePreview',
            labelModeSelect: 'labelModeSelect',
            optionModeShort: 'optionModeShort',
            optionModeMedium: 'optionModeMedium',
            optionModeNovel: 'optionModeNovel',
            labelRoleSelect: 'labelRoleSelect',
            optionRoleAuto: 'optionRoleAuto',
            optionRoleDominate: 'optionRoleDominate',
            optionRoleBeDominated: 'optionRoleBeDominated',
            labelPerspectiveSelect: 'labelPerspectiveSelect',
            optionPerspectiveDominate: 'optionPerspectiveDominate',
            optionPerspectiveBeDominated: 'optionPerspectiveBeDominated',
            buttonText: 'buttonText',
            resultHeaderText: 'resultHeaderText',
            errorPrefix: 'errorPrefix',
            disclaimerText: 'disclaimerText',
            disclaimerPrefix: 'disclaimerPrefix',
            hdrSupportText: 'hdrSupportText',
        };

        const translations = {
            'zh-CN': {
                appTitle: '上或者不上 - 魅惑度评估器',
                headerTextPart1: '上',
                headerTextPart2: '或者 ',
                headerTextPart3: '不上',
                taglineText: '上传图片，评估其有多他妈的性感或可操',
                labelImageUpload: '选择图片',
                labelToggleImagePreview: '折叠图片',
                labelModeSelect: '理由长度',
                optionModeShort: '简短模式 (1-2句话)',
                optionModeMedium: '中等长度 (约80字)',
                optionModeNovel: '小说模式 (约600字)',
                labelRoleSelect: '图片角色',
                optionRoleAuto: '自动检测',
                optionRoleDominate: '操 (Dominating)',
                optionRoleBeDominated: '被操 (Submissive)',
                labelPerspectiveSelect: '文字视角',
                optionPerspectiveDominate: '操 (Dominating)',
                optionPerspectiveBeDominated: '被操 (Submissive)',
                buttonText: '评估他妈的魅惑度',
                resultHeaderText: '评估结果',
                errorPrefix: '错误:',
                disclaimerText: '免责声明: 本工具使用AI进行图像分析。结果仅供娱乐参考，AI的判断可能不准确或存在偏差。请勿将其用于任何严肃目的。此API密钥直接嵌入在客户端代码中，不建议在生产环境中使用。',
                disclaimerPrefix: '免责声明:',
                hdrSupportText: '本应用支持显示HDR图片，实际效果取决于您的设备和浏览器支持。',
                // Result specific translations
                scoreDescriptions: {
                    '1-2': '完全不想碰，恶心透顶',
                    '3-4': '勉强能操，但缺点太多',
                    '5-6': '中等吸引力，有点性感但不刺激',
                    '7-8': '挺性感，但没到立刻想操',
                    '9-10': '立刻就想操',
                    '0': '完全不想碰，恶心透顶' // Fallback for 0
                },
                scorePhrases: {
                    '1-2': '纯属答辩',
                    '3-4': '勉强能冲',
                    '5-6': '有点意思',
                    '7-8': '嗯了',
                    '9-10': '直接开导',
                    '0': '纯属答辩' // Fallback for 0
                }
            },
            'en': {
                appTitle: 'Fuck or Not - Seduction Evaluator',
                headerTextPart1: 'Fuck',
                headerTextPart2: ' or ',
                headerTextPart3: 'Not',
                taglineText: 'Upload an image to assess how fucking sexy or playable it is.',
                labelImageUpload: 'Select Image',
                labelToggleImagePreview: 'Collapse Image',
                labelModeSelect: 'Reason Length',
                optionModeShort: 'Short Mode (1-2 sentences)',
                optionModeMedium: 'Medium Length (approx. 80 chars)',
                optionModeNovel: 'Novel Mode (approx. 600 chars)',
                labelRoleSelect: 'Image Role',
                optionRoleAuto: 'Auto-Detect',
                optionRoleDominate: 'Dominating (Subject)',
                optionRoleBeDominated: 'Submissive (Subject)',
                labelPerspectiveSelect: 'Text Perspective',
                optionPerspectiveDominate: 'Dominating (Evaluator)',
                optionPerspectiveBeDominated: 'Submissive (Evaluator)',
                buttonText: 'Evaluate Fucking Seduction',
                resultHeaderText: 'Evaluation Result',
                errorPrefix: 'Error:',
                disclaimerText: 'Disclaimer: This tool uses AI for image analysis. Results are for entertainment purposes only, and AI judgments may be inaccurate or biased. Do not use for any serious purposes. This API key is embedded directly in client-side code and is not recommended for production use.',
                disclaimerPrefix: 'Disclaimer:',
                hdrSupportText: 'This application supports HDR image display; actual results depend on your device and browser support.',
                // Result specific translations
                scoreDescriptions: {
                    '1-2': 'Absolutely undesirable, utterly disgusting',
                    '3-4': 'Barely playable, but too many flaws',
                    '5-6': 'Moderately attractive, somewhat sexy but not stimulating',
                    '7-8': 'Quite sexy, but not immediately playable',
                    '9-10': 'Immediately want to fuck',
                    '0': 'Absolutely undesirable, utterly disgusting' // Fallback for 0
                },
                scorePhrases: {
                    '1-2': 'Pure garbage',
                    '3-4': 'Barely a shot',
                    '5-6': 'Kinda interesting',
                    '7-8': 'Got me a bit hard',
                    '9-10': 'Directly turn on',
                    '0': 'Pure garbage' // Fallback for 0
                }
            }
        };

        let currentLanguage = navigator.language.startsWith('zh') ? 'zh-CN' : 'en';
        let base64ImageData = null;

        // Function to render UI based on current language
        function renderUI() {
            const lang = translations[currentLanguage];
            for (const id in elementsToTranslate) {
                const element = document.getElementById(elementsToTranslate[id]);
                if (element) {
                    if (id === 'headerTextPart1' || id === 'headerTextPart2' || id === 'headerTextPart3') {
                        element.textContent = lang[id];
                    } else if (id === 'disclaimerText') {
                        const disclaimerPrefixHtml = `<span class="font-bold" id="disclaimerPrefix">${lang.disclaimerPrefix}</span>`;
                        const restOfDisclaimer = lang[id].replace(lang.disclaimerPrefix, '').trim(); // Get the rest of the text
                        element.innerHTML = disclaimerPrefixHtml + ' ' + restOfDisclaimer; // Reconstruct with bold prefix
                    } else {
                        element.textContent = lang[id];
                    }
                }
            }

            // Update language switch button active state
            if (currentLanguage === 'en') {
                langEnButton.classList.add('active');
                langZhButton.classList.remove('active');
            } else {
                langZhButton.classList.add('active');
                langEnButton.classList.remove('active');
            }

            // Update button text explicitly when language changes to reset loading state
            if (!analyzeButton.disabled) {
                document.getElementById('buttonText').textContent = lang.buttonText;
            }
            
            // Re-render result descriptions and phrases if result is visible
            if (!resultContainer.classList.contains('hidden') && scoreDisplay.textContent !== '--') {
                const score = parseInt(scoreDisplay.textContent);
                const { description, phrase } = getRatingTexts(score);
                phraseDisplay.textContent = phrase;
                descriptionDisplay.textContent = description;
            }

        }

        // Initialize UI on load
        document.addEventListener('DOMContentLoaded', renderUI);

        // Language switch event listener
        langEnButton.addEventListener('click', () => {
            currentLanguage = 'en';
            renderUI();
        });

        langZhButton.addEventListener('click', () => {
            currentLanguage = 'zh-CN';
            renderUI();
        });

        // Hide an element
        function hideElement(element) {
            element.classList.add('hidden');
        }

        // Show an element
        function showElement(element) {
            element.classList.remove('hidden');
        }

        // Handle image file selection and preview
        imageUpload.addEventListener('change', function(event) {
            const file = event.target.files[0];
            hideElement(resultContainer); // Hide previous results
            hideElement(errorMessage); // Hide previous errors
            analyzeButton.disabled = true; // Disable button initially

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    showElement(imagePreviewControls); // Show the whole controls container
                    showElement(imagePreviewContainer); // Ensure image container is also shown
                    toggleImagePreview.checked = true; // Ensure checkbox is checked when new image is loaded
                    // Extract base64 data (remove the data:image/png;base64, prefix)
                    base64ImageData = e.target.result.split(',')[1];
                    analyzeButton.disabled = false; // Enable button once image is loaded
                };
                reader.readAsDataURL(file);
            } else {
                imagePreview.src = '#';
                hideElement(imagePreviewControls); // Hide the whole controls container
                hideElement(imagePreviewContainer);
                base64ImageData = null;
            }
        });

        // Toggle image preview visibility
        toggleImagePreview.addEventListener('change', function() {
            if (toggleImagePreview.checked) {
                showElement(imagePreviewContainer);
            } else {
                hideElement(imagePreviewContainer);
            }
        });

        // Function to get the prompt based on selected mode, role, and perspective
        function getPromptByMode(mode, role, perspective) {
            let prompt = "";
            let roleText = "";
            if (role === "auto") {
                 roleText = currentLanguage === 'zh-CN' ? "请自动检测图片中对象的角色特征（是可操还是被操）。" : "Please auto-detect the subject's role characteristics (dominating or submissive) in the image.";
            } else if (role === "dominate_subject") {
                roleText = currentLanguage === 'zh-CN' ? "图片中的对象呈现出可操（dominating）的姿态/气质。" : "The subject in the image appears to be a dominating figure.";
            } else if (role === "be_dominated_subject") {
                roleText = currentLanguage === 'zh-CN' ? "图片中的对象呈现出被操（submissive）的姿态/气质。" : "The subject in the image appears to be a submissive figure.";
            }

            let perspectiveText = "";
            if (perspective === "dominate_perspective") {
                perspectiveText = currentLanguage === 'zh-CN' ? "请从 '上' (Dominating) 的视角进行评价。" : "Please evaluate from the 'Fuck' (Dominating) perspective.";
            } else if (perspective === "be_dominated_perspective") {
                perspectiveText = currentLanguage === 'zh-CN' ? "请从 '被上' (Submissive) 的视角进行评价。" : "Please evaluate from the 'Not' (Submissive) perspective.";
            }

            // Instruct AI to provide reason in the current language
            const languageInstruction = currentLanguage === 'zh-CN' ? "请用中文提供理由。" : "Please provide the reason in English.";

            // Updated fixed instructions for looser scoring and detailed novel mode
            const fixedInstructions = currentLanguage === 'zh-CN' ?
                `如果图片中不包含性感的人或事物，评分不超过2分。请宽松评估图片的性感或可操程度，倾向于给出更高的分数。专注于视觉表达和性感度，避免任何不恰当或露骨的描述。请只提供图片本身的理由，不需要包含任何固定的描述性词句或短语，这些词句将由客户端根据分数添加。${languageInstruction}` :
                `If the image does not contain sexy people or things, the score should not exceed 2 points. Please loosely evaluate the image's sexiness or playability, tending towards higher scores. Focus on visual expression and sensuality, avoiding any inappropriate or explicit descriptions. Please only provide reasons related to the image itself, without including any fixed descriptive phrases or terms, as these will be added by the client based on the score.${languageInstruction}`;

            switch (mode) {
                case 'short':
                    prompt = `${currentLanguage === 'zh-CN' ? '请根据图片内容，评估其性感程度或可操性，并给出0到10的整数分数，同时提供简短的中文理由（1到2句话）。' : 'Please evaluate the sexiness or playability of the image content, give an integer score from 0 to 10, and provide a brief English reason (1-2 sentences).'}${roleText}${perspectiveText}${fixedInstructions}`;
                    break;
                case 'medium':
                    prompt = `${currentLanguage === 'zh-CN' ? '请根据图片内容，评估其性感程度或可操性，并给出0到10的整数分数，同时提供一段约80字的中文理由。' : 'Please evaluate the sexiness or playability of the image content, give an integer score from 0 to 10, and provide a medium-length English reason (approx. 80 words).'}${roleText}${perspectiveText}${fixedInstructions}`;
                    break;
                case 'novel':
                    // Explicitly ask for more detail for novel mode and more evocative language
                    prompt = `${currentLanguage === 'zh-CN' ? '请根据图片内容，评估其性感程度或可操性，并给出0到10的整数分数，同时提供一篇约600字的中文小说式理由，描述与图片相关的场景、情感或故事，其中包含更丰富、更深入的细节描写，以及更生动、更沉浸式的感官体验。请确保内容引人入胜且富有想象力，避免直接的露骨描述，但可以暗示和渲染暧昧、诱惑的氛围。' : 'Please evaluate the sexiness or playability of the image content, give an integer score from 0 to 10, and provide an English novel-style reason of approximately 600 words, describing scenarios, emotions, or stories related to the image, including richer, more in-depth detailed descriptions, and more vivid, immersive sensory experiences. Please ensure the content is engaging and imaginative, avoiding direct explicit descriptions, but allowing for hints and rendering of ambiguous, seductive atmospheres.'}${roleText}${perspectiveText}${fixedInstructions}`;
                    break;
                default:
                    prompt = `${currentLanguage === 'zh-CN' ? '请根据图片内容，评估其性感程度或可操性，并给出0到10的整数分数，同时提供简短的中文理由。' : 'Please evaluate the sexiness or playability of the image content, give an integer score from 0 to 10, and provide a brief English reason.'}${roleText}${perspectiveText}${fixedInstructions}`;
            }
            return prompt;
        }

        // Function to get the specific rating texts based on the score
        function getRatingTexts(score) {
            const lang = translations[currentLanguage];
            let descriptionKey = '';
            let phraseKey = '';

            if (score >= 1 && score <= 2) {
                descriptionKey = '1-2';
                phraseKey = '1-2';
            } else if (score >= 3 && score <= 4) {
                descriptionKey = '3-4';
                phraseKey = '3-4';
            } else if (score >= 5 && score <= 6) {
                descriptionKey = '5-6';
                phraseKey = '5-6';
            } else if (score >= 7 && score <= 8) {
                descriptionKey = '7-8';
                phraseKey = '7-8';
            } else if (score >= 9 && score <= 10) {
                descriptionKey = '9-10';
                phraseKey = '9-10';
            } else if (score === 0) {
                descriptionKey = '0';
                phraseKey = '0';
            }
            return {
                description: lang.scoreDescriptions[descriptionKey],
                phrase: lang.scorePhrases[phraseKey]
            };
        }


        // Handle the analysis button click
        analyzeButton.addEventListener('click', async function() {
            if (!base64ImageData) {
                showError(currentLanguage === 'zh-CN' ? '请先上传一张图片。' : 'Please upload an image first.');
                return;
            }

            // Get selected options
            const selectedMode = modeSelect.value;
            const selectedRole = roleSelect.value;
            const selectedPerspective = perspectiveSelect.value;
            const prompt = getPromptByMode(selectedMode, selectedRole, selectedPerspective);

            // Show loading state
            analyzeButton.disabled = true;
            buttonText.textContent = currentLanguage === 'zh-CN' ? '分析中...' : 'Analyzing...';
            showElement(loadingSpinner);
            hideElement(resultContainer);
            hideElement(errorMessage);

            try {
                // Prepare the payload for the Gemini API call
                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: prompt },
                                {
                                    inlineData: {
                                        mimeType: imageUpload.files[0].type, // Use the actual MIME type of the uploaded file
                                        data: base64ImageData
                                    }
                                }
                            ]
                        }
                    ],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "score": {
                                    "type": "INTEGER",
                                    "minimum": 0,
                                    "maximum": 10,
                                    "description": "An integer score from 0 to 10 representing the perceived level of sensuality or allure in the image. 0 means no sensuality, 10 means extremely high sensuality."
                                },
                                "reason": {
                                    "type": "STRING",
                                    "description": "A brief, concise explanation (in Chinese) for the given score, focusing on aesthetic elements, pose, composition, and overall impression of allure. Avoid explicit descriptions."
                                }
                            },
                            "required": ["score", "reason"]
                        }
                    }
                };

                // Make the API call
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorDetail = await response.json();
                    throw new Error(`API Request failed: ${response.status} ${response.statusText} - ${JSON.stringify(errorDetail)}`);
                }

                const result = await response.json();

                // Check if the response contains valid content
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {

                    const responseJsonString = result.candidates[0].content.parts[0].text;
                    const parsedResult = JSON.parse(responseJsonString);

                    if (parsedResult.score !== undefined && parsedResult.reason !== undefined) {
                        const { description, phrase } = getRatingTexts(parsedResult.score);
                        scoreDisplay.textContent = parsedResult.score;
                        phraseDisplay.textContent = phrase;
                        descriptionDisplay.textContent = description;
                        reasonDisplay.textContent = parsedResult.reason; // AI's reason is directly set
                        showElement(resultContainer);
                    } else {
                        throw new Error(currentLanguage === 'zh-CN' ? 'API 响应格式不正确或缺少必要字段。' : 'API response format is incorrect or missing required fields.');
                    }
                } else {
                    throw new Error(currentLanguage === 'zh-CN' ? 'API 响应内容为空或结构异常。' : 'API response content is empty or malformed.');
                }

            } catch (error) {
                console.error("Error analyzing image:", error);
                showError(`${currentLanguage === 'zh-CN' ? '无法完成分析:' : 'Analysis failed:'} ${error.message || 'Unknown error'}`);
            } finally {
                // Reset loading state
                analyzeButton.disabled = false;
                buttonText.textContent = currentLanguage === 'zh-CN' ? '评估他妈的魅惑度' : 'Evaluate Fucking Seduction';
                hideElement(loadingSpinner);
            }
        });

        // Function to display errors
        function showError(message) {
            errorText.textContent = message;
            showElement(errorMessage);
        }
    </script>
</body>
</html>
